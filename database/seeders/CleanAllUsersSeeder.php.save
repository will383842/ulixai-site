<?php

namespace Database\Seeders;

use Illuminate\Database\Seeder;
use App\Models\User;
use App\Models\ServiceProvider;
use App\Models\ProviderReview;
use Illuminate\Support\Facades\DB;
use Illuminate\Support\Facades\File;

class CleanAllUsersSeeder extends Seeder
{
    public function run()
    {
        if (config('app.env') === 'production') {
            $this->command->error('ðŸš¨ INTERDIT EN PRODUCTION !');
            return;
        }

        $this->command->warn('');
        $this->command->warn('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
        $this->command->warn('ðŸ§¹ NETTOYAGE : Service Providers & Service Requesters');
        $this->command->warn('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
        $this->command->warn('');
        
        if (!$this->command->confirm('ÃŠtes-vous sÃ»r de vouloir supprimer tous les providers et requesters ?', false)) {
            $this->command->info('âŒ OpÃ©ration annulÃ©e.');
            return;
        }

        $this->command->info('ðŸ§¹ DÃ‰BUT DU NETTOYAGE...');
        
        $adminsCount = User::whereIn('user_role', ['admin', 'superadmin', 'moderator'])->count();
        $this->command->info("ðŸ”’ Admins protÃ©gÃ©s : {$adminsCount}");

        $reviewCount = ProviderReview::count();
        if ($reviewCount > 0) {
            ProviderReview::truncate();
            $this->command->info("âœ“ {$reviewCount} avis supprimÃ©s");
        }

        $providerCount = ServiceProvider::count();
        if ($providerCount > 0) {
            ServiceProvider::truncate();
            $this->command->info("âœ“ {$providerCount} providers supprimÃ©s");
        }

        $providersToDelete = User::where('user_role', 'service_provider')->count();
        $requestersToDelete = User::where('user_role', 'service_requester')->count();
        
        if ($providersToDelete + $requestersToDelete > 0) {
            User::whereIn('user_role', ['service_provider', 'service_requester'])->delete();
            $this->command->info("âœ“ {$providersToDelete} providers + {$requestersToDelete} requesters supprimÃ©s");
        }

        $photoPath = public_path('assets/profileImages/');
        if (File::exists($photoPath)) {
            $files = File::files($photoPath);
            $photoCount = 0;
            foreach ($files as $file) {
                if (preg_match('/^profile-.*\.jpg$/', $file->getFilename())) {
                    File::delete($file->getPathname());
                    $photoCount++;
                }
            }
            if ($photoCount > 0) {
                $this->command->info("âœ“ {$photoCount} photos supprimÃ©es");
            }
        }

        try {
            DB::statement('ALTER TABLE provider_reviews AUTO_INCREMENT = 1');
            DB::statement('ALTER TABLE service_providers AUTO_INCREMENT = 1');
            $this->command->info('âœ“ Compteurs rÃ©initialisÃ©s');
        } catch (\Exception $e) {
            $this->command->warn('âš  Erreur compteurs');
        }

        $this->command->info('');
        $this->command->info('âœ… NETTOYAGE TERMINÃ‰ !');
        $this->command->info("âœ… {$adminsCount} admin(s) conservÃ©(s)");
        $this->command->info('');
    }
}